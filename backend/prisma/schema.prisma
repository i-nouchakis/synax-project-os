// Synax Database Schema
// Based on PLAN.md specifications

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Users & Authentication
// ============================================

enum UserRole {
  ADMIN
  PM
  TECHNICIAN
  CLIENT
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String
  role          UserRole  @default(TECHNICIAN)
  avatar        String?
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  projectMembers     ProjectMember[]
  assignedAssets     Asset[]            @relation("InstalledBy")
  assignedChecklists Checklist[]        @relation("AssignedTo")
  createdIssues      Issue[]            @relation("CreatedBy")
  issueComments      IssueComment[]
  inventoryLogs      InventoryLog[]
  signatures         Signature[]
  generatedReports   GeneratedReport[]  @relation("GeneratedReports")
  completedChecklistItems ChecklistItem[] @relation("CompletedBy")
  timeEntries        TimeEntry[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  email     String
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("password_reset_tokens")
}

// ============================================
// Projects & Hierarchy
// ============================================

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  ARCHIVED
}

model Project {
  id          String        @id @default(cuid())
  name        String
  description String?
  clientName  String        @map("client_name")
  location    String?
  status      ProjectStatus @default(PLANNING)
  startDate   DateTime?     @map("start_date")
  endDate     DateTime?     @map("end_date")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  members          ProjectMember[]
  floors           Floor[]
  issues           Issue[]
  inventory        InventoryItem[]
  signatures       Signature[]
  generatedReports GeneratedReport[]
  timeEntries      TimeEntry[]

  @@map("projects")
}

model ProjectMember {
  id        String   @id @default(cuid())
  projectId String   @map("project_id")
  userId    String   @map("user_id")
  role      UserRole @default(TECHNICIAN)
  joinedAt  DateTime @default(now()) @map("joined_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_members")
}

model Floor {
  id            String   @id @default(cuid())
  projectId     String   @map("project_id")
  name          String
  level         Int      @default(0)
  floorplanUrl  String?  @map("floorplan_url")
  floorplanType String?  @map("floorplan_type") // 'pdf', 'dwg', 'svg', 'image'
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  rooms   Room[]

  @@map("floors")
}

enum RoomStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

model Room {
  id            String     @id @default(cuid())
  floorId       String     @map("floor_id")
  name          String
  type          String?    // 'server_room', 'office', 'meeting_room', etc.
  pinX          Float?     @map("pin_x")
  pinY          Float?     @map("pin_y")
  status        RoomStatus @default(NOT_STARTED)
  notes         String?
  floorplanUrl  String?    @map("floorplan_url")
  floorplanType String?    @map("floorplan_type") // 'IMAGE' or 'PDF'
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Relations
  floor       Floor       @relation(fields: [floorId], references: [id], onDelete: Cascade)
  assets      Asset[]
  issues      Issue[]
  signatures  Signature[]
  timeEntries TimeEntry[]

  @@map("rooms")
}

// ============================================
// Assets & Equipment
// ============================================

enum AssetStatus {
  PLANNED
  IN_STOCK
  INSTALLED
  CONFIGURED
  VERIFIED
  FAULTY
}

model AssetType {
  id                String  @id @default(cuid())
  name              String  @unique
  icon              String?
  checklistTemplate Json?   @map("checklist_template")

  // Relations
  assets Asset[]

  @@map("asset_types")
}

model Asset {
  id            String      @id @default(cuid())
  roomId        String      @map("room_id")
  assetTypeId   String?     @map("asset_type_id")
  name          String
  model         String?
  serialNumber  String?     @map("serial_number")
  macAddress    String?     @map("mac_address")
  ipAddress     String?     @map("ip_address")
  status        AssetStatus @default(PLANNED)
  installedById String?     @map("installed_by_id")
  installedAt   DateTime?   @map("installed_at")
  notes         String?
  pinX          Float?      @map("pin_x")  // Position on room floor plan
  pinY          Float?      @map("pin_y")  // Position on room floor plan
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  // Relations
  room        Room        @relation(fields: [roomId], references: [id], onDelete: Cascade)
  assetType   AssetType?  @relation(fields: [assetTypeId], references: [id])
  installedBy User?       @relation("InstalledBy", fields: [installedById], references: [id])
  checklists  Checklist[]
  timeEntries TimeEntry[]

  @@map("assets")
}

// ============================================
// Checklists
// ============================================

enum ChecklistStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum ChecklistType {
  CABLING
  EQUIPMENT
  CONFIG
  DOCUMENTATION
}

model Checklist {
  id           String          @id @default(cuid())
  assetId      String          @map("asset_id")
  type         ChecklistType
  status       ChecklistStatus @default(NOT_STARTED)
  assignedToId String?         @map("assigned_to_id")
  completedAt  DateTime?       @map("completed_at")
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  // Relations
  asset      Asset           @relation(fields: [assetId], references: [id], onDelete: Cascade)
  assignedTo User?           @relation("AssignedTo", fields: [assignedToId], references: [id])
  items      ChecklistItem[]

  @@map("checklists")
}

model ChecklistItem {
  id            String    @id @default(cuid())
  checklistId   String    @map("checklist_id")
  name          String
  description   String?
  isRequired    Boolean   @default(true) @map("is_required")
  requiresPhoto Boolean   @default(false) @map("requires_photo")
  completed     Boolean   @default(false)
  completedById String?   @map("completed_by_id")
  completedAt   DateTime? @map("completed_at")
  order         Int       @default(0)
  createdAt     DateTime  @default(now()) @map("created_at")

  // Relations
  checklist   Checklist        @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  completedBy User?            @relation("CompletedBy", fields: [completedById], references: [id])
  photos      ChecklistPhoto[]

  @@map("checklist_items")
}

model ChecklistPhoto {
  id              String   @id @default(cuid())
  checklistItemId String   @map("checklist_item_id")
  photoUrl        String   @map("photo_url")
  caption         String?
  uploadedAt      DateTime @default(now()) @map("uploaded_at")

  // Relations
  checklistItem ChecklistItem @relation(fields: [checklistItemId], references: [id], onDelete: Cascade)

  @@map("checklist_photos")
}

// ============================================
// Issues / Snag Tracking
// ============================================

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

model Issue {
  id          String        @id @default(cuid())
  projectId   String        @map("project_id")
  roomId      String?       @map("room_id")
  title       String
  description String?
  causedBy    String?       @map("caused_by") // Third party responsible
  priority    IssuePriority @default(MEDIUM)
  status      IssueStatus   @default(OPEN)
  createdById String        @map("created_by_id")
  resolvedAt  DateTime?     @map("resolved_at")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  project   Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  room      Room?          @relation(fields: [roomId], references: [id])
  createdBy User           @relation("CreatedBy", fields: [createdById], references: [id])
  photos    IssuePhoto[]
  comments  IssueComment[]

  @@map("issues")
}

model IssuePhoto {
  id         String   @id @default(cuid())
  issueId    String   @map("issue_id")
  photoUrl   String   @map("photo_url")
  caption    String?
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  // Relations
  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@map("issue_photos")
}

model IssueComment {
  id        String   @id @default(cuid())
  issueId   String   @map("issue_id")
  userId    String   @map("user_id")
  comment   String
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id])

  @@map("issue_comments")
}

// ============================================
// Inventory
// ============================================

enum InventoryAction {
  RECEIVED
  CONSUMED
  RETURNED
  ADJUSTED
}

model InventoryItem {
  id               String   @id @default(cuid())
  projectId        String   @map("project_id")
  itemType         String   @map("item_type")
  description      String
  unit             String   @default("pcs")
  quantityReceived Int      @default(0) @map("quantity_received")
  quantityUsed     Int      @default(0) @map("quantity_used")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  project Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  logs    InventoryLog[]

  @@map("inventory_items")
}

model InventoryLog {
  id            String          @id @default(cuid())
  itemId        String          @map("item_id")
  action        InventoryAction
  quantity      Int
  serialNumbers String[]        @map("serial_numbers")
  notes         String?
  userId        String          @map("user_id")
  createdAt     DateTime        @default(now()) @map("created_at")

  // Relations
  item InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user User          @relation(fields: [userId], references: [id])

  @@map("inventory_logs")
}

// ============================================
// Signatures
// ============================================

enum SignatureType {
  ROOM_HANDOVER
  STAGE_COMPLETION
  FINAL_ACCEPTANCE
}

model Signature {
  id            String        @id @default(cuid())
  projectId     String        @map("project_id")
  roomId        String?       @map("room_id")
  type          SignatureType
  signatureData String        @map("signature_data") // Base64 or URL
  signedByName  String        @map("signed_by_name")
  signedById    String?       @map("signed_by_id")
  signedAt      DateTime      @default(now()) @map("signed_at")

  // Relations
  project  Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  room     Room?   @relation(fields: [roomId], references: [id])
  signedBy User?   @relation(fields: [signedById], references: [id])

  @@map("signatures")
}

// ============================================
// Time Tracking
// ============================================

enum TimeEntryType {
  INSTALLATION
  CONFIGURATION
  TESTING
  TROUBLESHOOTING
  TRAVEL
  MEETING
  OTHER
}

model TimeEntry {
  id          String        @id @default(cuid())
  projectId   String        @map("project_id")
  userId      String        @map("user_id")
  roomId      String?       @map("room_id")
  assetId     String?       @map("asset_id")
  type        TimeEntryType @default(OTHER)
  description String?
  date        DateTime      @default(now())
  startTime   DateTime?     @map("start_time")
  endTime     DateTime?     @map("end_time")
  hours       Float         // Manual entry or calculated from start/end
  notes       String?
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])
  room    Room?   @relation(fields: [roomId], references: [id])
  asset   Asset?  @relation(fields: [assetId], references: [id])

  @@map("time_entries")
}

// ============================================
// Generated Reports
// ============================================

enum ReportType {
  SUMMARY
  CLIENT
  INTERNAL
  ASSETS
}

model GeneratedReport {
  id          String     @id @default(cuid())
  projectId   String     @map("project_id")
  type        ReportType
  title       String
  fileUrl     String     @map("file_url")
  fileSize    Int        @map("file_size")
  generatedById String   @map("generated_by_id")
  createdAt   DateTime   @default(now()) @map("created_at")

  // Relations
  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  generatedBy User    @relation("GeneratedReports", fields: [generatedById], references: [id])

  @@map("generated_reports")
}
